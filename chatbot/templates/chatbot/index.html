<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPI Technologies Chatbot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: #2c3e50;
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .invitation-container {
      background: white;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 90%;
      position: relative;
    }

    .logo {
      margin-bottom: 20px;
      color: #3498db;
      font-size: 2.5rem;
    }
    .logo-image {
        max-width: 120px;
        max-height: 120px;
        margin-bottom: 20px;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    p {
      margin-bottom: 25px;
      color: #7f8c8d;
    }

    .start-btn {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1rem;
      border-radius: 24px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
    }

    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .start-btn.loading {
      color: transparent;
    }

    /* Loader spinner */
    .loader {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 25px;
      height: 25px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Chat page styles (hidden initially) */
    .chat-page {
      display: none;
      width: 100%;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .info-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .info-panel h2 {
      color: #3498db;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f1f1;
    }

    .features {
      list-style: none;
    }

    .features li {
      padding: 12px 0;
      border-bottom: 1px solid #f1f1f1;
      display: flex;
      align-items: center;
    }

    .features li:last-child {
      border-bottom: none;
    }

    .features li::before {
      content: "âœ“";
      color: #2ecc71;
      font-weight: bold;
      margin-right: 10px;
      background: rgba(46, 204, 113, 0.1);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      height: 600px;
    }

    #chat-header {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
      padding: 20px;
      font-weight: 600;
      font-size: 18px;
      display: flex;
      align-items: center;
    }

    #chat-header::before {
      content: '';
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2ecc71;
      margin-right: 12px;
    }

    #chatbox {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
    }

    .message-container {
      display: flex;
      margin: 10px 0;
      width: 100%;
    }

    .message-container.user {
      justify-content: flex-end;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
      font-size: 15px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bot {
      background: #fff;
      color: #333;
      border-top-left-radius: 4px;
      border: 1px solid #e6e6e6;
    }

    .user {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
      border-top-right-radius: 4px;
    }

    #chat-input {
      display: flex;
      border-top: 1px solid #e6e6e6;
      background: #fff;
      padding: 15px 20px;
      align-items: center;
    }

    #userInput {
      flex: 1;
      border: 1px solid #e6e6e6;
      padding: 12px 15px;
      font-size: 15px;
      outline: none;
      color: #333;
      border-radius: 24px;
      margin-right: 10px;
    }

    #sendBtn {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 24px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    #sendBtn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* Typing animation */
    .typing {
      font-style: italic;
      color: #888;
      margin: 10px 0;
      display: flex;
      align-items: center;
    }

    .typing-dots {
      display: flex;
      margin-left: 8px;
    }

    .typing-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #888;
      margin: 0 3px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }

    /* Custom scrollbar */
    #chatbox::-webkit-scrollbar {
      width: 8px;
    }

    #chatbox::-webkit-scrollbar-track {
      background: transparent;
    }

    #chatbox::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    #chatbox::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .examples {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .example-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }

    .example-card:hover {
      transform: translateY(-5px);
    }

    .example-card h3 {
      color: #3498db;
      margin-bottom: 15px;
    }

    .example-card p {
      color: #7f8c8d;
    }

    footer {
      text-align: center;
      padding: 30px 0;
      margin-top: 50px;
      color: #7f8c8d;
      border-top: 1px solid #e6e6e6;
    }
  </style>
</head>
<body>
  <!-- Invitation Page -->
  <div class="invitation-container" id="invitationPage">
    <div class="logo">
      <img src="https://cpitechinc.com/wp-content/uploads/2023/07/logo.png" alt="CPI Technologies Logo" class="logo-image">
    </div>
    <h1>You've been invited to have a conversation with CPI Technologies Chatbot</h1>
    <p>Want to create your own?</p>
    <button class="start-btn" id="startBtn" onclick="startConversation()">
      Start Conversation
      <div class="loader" id="loader"></div>
    </button>
  </div>
  
  <!-- Chat Page (initially hidden) -->
  <div class="chat-page" id="chatPage">
    <div class="container">
      <header>
        <div class="logo">
            <img src="https://cpitechinc.com/wp-content/uploads/2023/07/logo.png" alt="CPI Technologies Logo" class="logo-image">
            <p class="subtitle">Get instant answers to your questions with our intelligent chatbot powered by CPI Technologies</p>
        </div>
      </header>

      <div class="main-content">
        <div class="info-panel">
          <h2>How It Works</h2>
          <ul class="features">
            <li>Ask questions in natural language</li>
            <li>Get instant, accurate responses</li>
            <li>24/7 availability for your convenience</li>
            <li>Secure and private conversations</li>
            <li>Context-aware responses for better understanding</li>
            <li>Multi-language support</li>
          </ul>

          <div class="examples">
            <div class="example-card">
              <h3>Customer Support</h3>
              <p>"How can I reset my password?"</p>
            </div>
            <div class="example-card">
              <h3>Product Information</h3>
              <p>"What are the features of your premium plan?"</p>
            </div>
            <div class="example-card">
              <h3>Troubleshooting</h3>
              <p>"Why is my account not working?"</p>
            </div>
          </div>
        </div>

        <div class="chat-container">
          <div id="chat-header">AI Assistant</div>
          <div id="chatbox">
            <div class="message-container">
              <div class="message bot">Hello! I'm your AI assistant. How can I help you today?</div>
            </div>
            <div class="message-container">
              <div class="message bot">You can ask me questions about our products, services, or get help with any issues you're experiencing.</div>
            </div>
          </div>
          <div id="chat-input">
            <input type="text" id="userInput" placeholder="Type your message here..." onkeypress="if(event.key==='Enter'){sendMessage();}">
            <button id="sendBtn" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>

      <footer>
        <p>Â© 2025 CPI Technologies. All rights reserved.</p>
      </footer>
    </div>
  </div>

  <script>
    // Add this variable to track the current node
    let currentNodeId = null;
    
    // Get references to elements
    const startBtn = document.getElementById('startBtn');
    const loader = document.getElementById('loader');

    // Update the startConversation function
    function startConversation() {
  // Show loader and disable button
  startBtn.classList.add('loading');
  loader.style.display = 'block';
  
  // Check if user is authenticated by making a request to a protected endpoint
  fetch('/get_start_node/')
    .then(res => {
      if (res.status === 403 || res.status === 401) {
        // User is not authenticated, redirect to login
        window.location.href = '/';
        return Promise.reject('Not authenticated');
      }
      return res.json();
    })
    .then(data => {
      if (data.current_node) {
        currentNodeId = data.current_node;
      }
      
      // Hide invitation page and show chat page after a short delay
      setTimeout(() => {
        document.getElementById('invitationPage').style.display = 'none';
        document.getElementById('chatPage').style.display = 'block';
        
        // Reset button state
        startBtn.classList.remove('loading');
        loader.style.display = 'none';
      }, 1000); // 1 second delay to show the spinner
    })
    .catch(error => {
      console.error('Error:', error);
      // Reset button state even if there's an error
      startBtn.classList.remove('loading');
      loader.style.display = 'none';
      
      // If it's an authentication error, we've already redirected
      if (error !== 'Not authenticated') {
        // Still transition to chat page for other errors
        document.getElementById('invitationPage').style.display = 'none';
        document.getElementById('chatPage').style.display = 'block';
      }
    });
}

    // Update the sendMessage function to include current node
    function sendMessage() {
      let input = document.getElementById("userInput");
      let text = input.value.trim();
      if (!text) return;

      // Add user message
      const userMessageContainer = document.createElement("div");
      userMessageContainer.className = "message-container user";
      userMessageContainer.innerHTML = `<div class="message user">${text}</div>`;
      chatbox.appendChild(userMessageContainer);
      chatbox.scrollTop = chatbox.scrollHeight;

      // Show typing indicator
      const typingContainer = document.createElement("div");
      typingContainer.className = "message-container";
      typingContainer.innerHTML = `
        <div class="message bot typing">
          Thinking
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      chatbox.appendChild(typingContainer);
      chatbox.scrollTop = chatbox.scrollHeight;

      // Send to backend with current node
      fetch('/reply/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          message: text,
          current_node: currentNodeId
        })
      })
        .then(res => res.json())
        .then(data => {
          // Remove typing
          typingContainer.remove();

          // Update current node
          if (data.current_node) {
            currentNodeId = data.current_node;
          }

          // Show bot response
          const botMessageContainer = document.createElement("div");
          botMessageContainer.className = "message-container";
          botMessageContainer.innerHTML = `<div class="message bot">${data.response}</div>`;
          chatbox.appendChild(botMessageContainer);
          chatbox.scrollTop = chatbox.scrollHeight;
        })
        .catch(err => {
          typingContainer.remove();
          const errorContainer = document.createElement("div");
          errorContainer.className = "message-container";
          errorContainer.innerHTML = `<div class="message bot">Sorry, I'm having trouble connecting right now. Please try again later.</div>`;
          chatbox.appendChild(errorContainer);
          chatbox.scrollTop = chatbox.scrollHeight;
        });

      input.value = "";
    }

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
  
</body>
</html>